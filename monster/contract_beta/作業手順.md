# Tragedy NFT V5 デプロイ手順書

このドキュメントは、Tragedy NFT V5システムを本番環境にデプロイするための実践的な手順書です。
実際の作業を通じて記録された手順を記載します。

## 作業開始
- 日時: 2025-08-06
- 作業者: Claude
- 環境: formal_procedure_p2

## 作業手順

### 1. 環境セットアップ

#### 1.1 初期状態確認
```bash
cd /Users/goodsun/Desktop/generativeNft/monster/tragedyContract/formal_procedure_p2
ls -la
```

依存パッケージがインストールされていない状態を確認：
```bash
npm list
# → UNMET DEPENDENCY エラーが表示される
```

#### 1.2 依存パッケージのインストール
```bash
npm install
```

インストール結果：
- 1384パッケージが正常にインストール
- 警告：一部の非推奨パッケージが含まれている（ganache-core等）
- 注意：脆弱性が検出されたが、開発環境のため一旦継続

#### 1.3 Hardhatコンパイル確認
```bash
npx hardhat compile
```

コンパイル結果：
- 32個のSolidityファイルが正常にコンパイル
- 警告：TragedyMetadataV5.solに未使用パラメータの警告（動作には影響なし）

### 2. 環境設定ファイルの準備

#### 2.1 .envファイルの作成
```bash
cp .env.example .env
```

**重要**: .envファイルに以下の情報を設定する必要があります：
- PRIVATE_KEY: デプロイ用のウォレット秘密鍵（0xプレフィックスなし）
- BONSOLEIL_RPC_URL: Bon-Soleil TestnetのRPC URL

### 3. デプロイスクリプトの確認

#### 3.1 デプロイスクリプトの存在確認
```bash
ls -la scripts/deploy-production.js
```

スクリプトが存在することを確認。
このスクリプトは以下の順序でコントラクトをデプロイします：

1. ArweaveMonsterBankV3（全モンスターSVGを含む）
2. ArweaveBackgroundBank（背景のArweave URLs）
3. ArweaveItemBankV3（全アイテムSVGを含む）
4. ArweaveEffectBank（エフェクトのArweave URLs）
5. ArweaveTragedyComposerV5（SVG合成処理）
6. TragedyMetadataV5（メタデータ生成）
7. BankedNFT（メインNFTコントラクト）

### 4. コントラクトのデプロイ

**注意**: 実際のデプロイ前に.envファイルにPRIVATE_KEYとBONSOLEIL_RPC_URLを設定する必要があります。

#### 4.1 デプロイ実行（本番環境の場合）
```bash
npx hardhat run scripts/deploy-production.js --network bonsoleil
```

**デプロイ完了時の情報**：
- deployment.jsonファイルが自動的に作成/更新される
- deploymentsフォルダにタイムスタンプ付きのバックアップが保存される
- viewer/deployment.jsonも同時に更新される

### 5. デプロイ後の確認

#### 5.1 デプロイ結果の確認
```bash
cat viewer/deployment.json
```

現在のデプロイ済みコントラクト（例）：
```json
{
  "network": "bonsoleil",
  "timestamp": "2025-08-06T10:57:48.628Z",
  "note": "Fixed JSON comma issue in MetadataV5",
  "contracts": {
    "bankedNFT": "0xb0C8bCef9bBEd995b18E0fe6cB7029cB7c90E796",
    "metadataV5": "0x558c7489B997F0cFE8dA4aD0C492b9c4485ACb43",
    "composerV5": "0xeBaC476812E5D2F2f85A849CeC69AB210E010C5D",
    "monsterBankV3": "0x315A5C0FEf9fB193e2EaF4eE22D112DEC98A386F",
    "itemBankV3": "0x2A76B76D2024bDf8018459cbf789A5B0bd277Fdc",
    "backgroundBank": "0x6046CaAe3899Aea62A75584781F47BF1BD1700A3",
    "effectBank": "0xC280F8Ef799011c2E47d667E68ea968f10894f35"
  }
}
```

### 6. ビューワーでの動作確認

#### 6.1 ビューワーファイルの確認
```bash
ls -la viewer/
```

利用可能なビューワー：
- **index.html**: メインビューワー（Material Explorer、Composer Explorer、NFT Viewerの統合版）
- **material-explorer.html**: マテリアル確認専用
- **composer-explorer.html**: コンポーザー動作確認専用
- **v5-viewer.html**: V5システム専用ビューワー
- **banked-metadata-explorer.html**: メタデータ探索ツール

#### 6.2 ビューワーの起動
```bash
# Python HTTPサーバーを使用
cd viewer
python3 -m http.server 8000
```

ブラウザで http://localhost:8000/index.html にアクセス

#### 6.3 ビューワーでの確認手順

1. **Material Explorer**タブ：
   - 各Bank（Monster、Item、Background、Effect）のマテリアルが正しく表示されるか確認
   - SVGの表示とArweave URLの確認

2. **Composer Explorer**タブ：
   - ランダム生成ボタンでSVGが正しく合成されるか確認
   - 各パラメータ（Species、Equipment、Realm、Curse）の組み合わせ確認

3. **NFT Viewer**タブ：
   - ウォレット接続
   - NFTのミント
   - ミント済みNFTの表示確認

### 7. トラブルシューティング

#### 7.1 よくある問題と対処法

**問題1**: "Failed to load deployment configuration"エラー
- 原因：deployment.jsonが見つからない
- 対処：デプロイスクリプトを実行してdeployment.jsonを生成

**問題2**: MetaMask接続エラー
- 原因：ネットワーク設定の不一致
- 対処：Bon-Soleil Testnet（Chain ID: 21201）を追加

**問題3**: "missing revert data"エラー
- 原因：コントラクトアドレスの不一致やインターフェースの問題
- 対処：deployment.jsonの内容を確認し、最新のデプロイアドレスを使用

### 8. 本番環境へのデプロイ準備

#### 8.1 チェックリスト
- [ ] .envファイルに本番用の秘密鍵を設定
- [ ] hardhat.config.jsに本番ネットワークの設定を追加
- [ ] ガス価格の確認と設定
- [ ] コントラクトの最終テスト完了
- [ ] deployment.jsonのバックアップ

#### 8.2 デプロイ後の作業
- [ ] Etherscanでのコントラクト検証
- [ ] オーナー権限の確認
- [ ] ミント機能のテスト
- [ ] ロイヤリティ設定の確認

## 実際のデプロイ結果（2025-08-06）

### デプロイ成功時の出力例
```
Deploying contracts with the account: 0xCf20a6EcBBedB403DB466D669229d9Ee379C433f
Account balance: 199989858119903000000000

1. Deploying MonsterBank1...
MonsterBank1 deployed to: 0xc6E63bC65201BeBEa01a975e02f6c5C2B8f68cc9

2. Deploying MonsterBank2...
MonsterBank2 deployed to: 0xBfd8838C25608c7DF82DaC5B95be004a8a7D3114

3. Deploying MonsterBankV3...
MonsterBankV3 deployed to: 0xc5dC1c5F923edA5eBe4765fE5A2E10Ae03D8b123

4. Deploying ItemBank1...
ItemBank1 deployed to: 0xC449009B332c68b6Bf688Dd15b39cA4B7521c3e1

5. Deploying ItemBank2...
ItemBank2 deployed to: 0x76a5F990bCe8946b380DB5E0ae2CCD26d0472B01

6. Deploying ItemBankV3...
ItemBankV3 deployed to: 0x7485194fCeB774f1eb5Dc12CF852ED0541FcfF22

7. Deploying BackgroundBank...
BackgroundBank deployed to: 0xf368EB1eD47121B445F92E0Cc49a3F7Ceb96E64C

8. Deploying EffectBank...
EffectBank deployed to: 0xFc0F05BfC0cd5e7e066b78879c32Efa518468dce

9. Deploying ComposerV5...
ComposerV5 deployed to: 0x078b4d91BA92177c2a01d4A84aE78e24b603d10E

10. Deploying MetadataV5...
MetadataV5 deployed to: 0xd5a61216F7E97798bE5Dbc9Fd8D72C8Fd468b705

11. Deploying BankedNFT...
BankedNFT deployed to: 0x96a960FA0c267dc9fa64f61C849d6D0e88801d34
Setting metadata bank...
Metadata bank set successfully!

=== DEPLOYMENT COMPLETE ===
Deployment saved to: deployments/bonsoleil-1754493037463.json

Contract addresses:
- BankedNFT: 0x96a960FA0c267dc9fa64f61C849d6D0e88801d34
- MetadataV5: 0xd5a61216F7E97798bE5Dbc9Fd8D72C8Fd468b705
- ComposerV5: 0x078b4d91BA92177c2a01d4A84aE78e24b603d10E
- MonsterBankV3: 0xc5dC1c5F923edA5eBe4765fE5A2E10Ae03D8b123
- ItemBankV3: 0x7485194fCeB774f1eb5Dc12CF852ED0541FcfF22
- BackgroundBank: 0xf368EB1eD47121B445F92E0Cc49a3F7Ceb96E64C
- EffectBank: 0xFc0F05BfC0cd5e7e066b78879c32Efa518468dce

=== VERIFYING DEPLOYMENT ===
✓ Metadata generation works!
✓ Metadata count: 10000
✓ Composer link verified: true
```

### デプロイパラメータ
- **maxSupply**: 10,000 NFTs
- **mintFee**: 0.01 ETH
- **royaltyRate**: 2.5% (250 basis points)

### 注意事項
1. デプロイスクリプトの修正が必要でした（個別のバンクを先にデプロイ）
2. BankedNFTコントラクトは5つの引数が必要
3. MetadataBankの設定は別トランザクションで実行