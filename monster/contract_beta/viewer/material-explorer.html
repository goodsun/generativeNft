<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Explorer - Bank Layer Test</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        
        h1 {
            background: linear-gradient(45deg, #ff6b6b, #dc143c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }
        
        .bank-section {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .bank-section h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        
        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .material-item {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .material-item:hover {
            background: #3a3a3a;
            transform: translateY(-2px);
        }
        
        .material-item.error {
            background: #330000;
            border: 1px solid #660000;
        }
        
        .svg-container {
            width: 96px;
            height: 96px;
            background: white;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }
        
        .svg-container svg {
            max-width: 96px;
            max-height: 96px;
        }
        
        .material-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .material-id {
            font-size: 12px;
            color: #888;
        }
        
        .status {
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .loading {
            color: #ff6b6b;
        }
        
        .error-msg {
            color: #ff4444;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .bank-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Material Explorer</h1>
    <div class="status" id="status">
        <span class="loading">Initializing...</span>
    </div>
    
    <div id="banks-container"></div>
    
    <script>
        const RPC_URL = "https://dev2.bon-soleil.com/rpc";
        const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        
        // Default addresses - will be overridden by deployment.json if available
        let BANKS = {
            monster: {
                v3: "0x41717f85854D631F7cb856D634fBf396beb68C93",
                bank1: "0xe4fc503255De4F536BBC43Fe339843F88E2e1E66",
                bank2: "0xE7b23Cc85D6D9b24C4203F26A97DF7A80F9FA047"
            },
            item: {
                v3: "0x2A76B76D2024bDf8018459cbf789A5B0bd277Fdc",
                bank1: "0x125F456DD6633E9E698FC084Ac669E08B133daaA",
                bank2: "0x86F003F07704F2939FB5eD40e16f13521D6c930E"
            },
            background: {
                main: "0x1103d4c6108705610B08c2FFA696e3589579931E"
            },
            effect: {
                main: "0xA1D8e09E0F6559e992e2882555F60bE67F4e73a9"
            }
        };
        
        // Load deployment configuration
        async function loadDeployment() {
            try {
                console.log("Loading deployment.json...");
                const response = await fetch("deployment.json");
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const deployment = await response.json();
                console.log("Loaded deployment:", deployment);
                
                // Update BANKS with addresses from deployment.json
                if (deployment.contracts) {
                    BANKS = {
                        monster: {
                            main: deployment.contracts.monsterBank || BANKS.monster.v3,
                            bank1: deployment.contracts.monsterBank1 || BANKS.monster.bank1,
                            bank2: deployment.contracts.monsterBank2 || BANKS.monster.bank2
                        },
                        item: {
                            main: deployment.contracts.itemBank || BANKS.item.v3,
                            bank1: deployment.contracts.itemBank1 || BANKS.item.bank1,
                            bank2: deployment.contracts.itemBank2 || BANKS.item.bank2
                        },
                        background: {
                            main: deployment.contracts.backgroundBank || BANKS.background.main
                        },
                        effect: {
                            main: deployment.contracts.effectBank || BANKS.effect.main
                        }
                    };
                    
                    console.log("Updated BANKS with deployment addresses:", BANKS);
                    
                    // Update UI with new addresses
                    updateContractInfo();
                }
            } catch (error) {
                console.error("Failed to load deployment.json:", error);
                console.log("Using default addresses");
            }
        }
        
        // Update contract info display
        function updateContractInfo() {
            const monsterInfo = document.querySelector('#materials-tab .bank-info:nth-child(1)');
            const itemInfo = document.querySelector('#materials-tab .bank-info:nth-child(2)');
            const backgroundInfo = document.querySelector('#materials-tab .bank-info:nth-child(3)');
            const effectInfo = document.querySelector('#materials-tab .bank-info:nth-child(4)');
            
            if (monsterInfo) {
                monsterInfo.innerHTML = `
                    <h3>Monster Bank</h3>
                    <div>Address: ${BANKS.monster.main}</div>
                    <div>Bank1: ${BANKS.monster.bank1}</div>
                    <div>Bank2: ${BANKS.monster.bank2}</div>
                `;
            }
            
            if (itemInfo) {
                itemInfo.innerHTML = `
                    <h3>Item Bank</h3>
                    <div>Address: ${BANKS.item.main}</div>
                    <div>Bank1: ${BANKS.item.bank1}</div>
                    <div>Bank2: ${BANKS.item.bank2}</div>
                `;
            }
            
            if (backgroundInfo) {
                backgroundInfo.innerHTML = `
                    <h3>Background Bank</h3>
                    <div>Address: ${BANKS.background.main}</div>
                `;
            }
            
            if (effectInfo) {
                effectInfo.innerHTML = `
                    <h3>Effect Bank</h3>
                    <div>Address: ${BANKS.effect.main}</div>
                `;
            }
        };
        
        const BANK_ABI = [
            "function getSVG(uint8 id) view returns (string)",
            "function getMonsterSVG(uint8 id) view returns (string)",
            "function getItemSVG(uint8 id) view returns (string)",
            "function getBackgroundSVG(uint8 id) view returns (string)",
            "function getEffectSVG(uint8 id) view returns (string)",
            "function getMonsterName(uint8 id) view returns (string)",
            "function getItemName(uint8 id) view returns (string)",
            "function getBackgroundName(uint8 id) view returns (string)",
            "function getEffectName(uint8 id) view returns (string)"
        ];
        
        const MATERIAL_COUNTS = {
            monster: 10,
            item: 12,
            background: 10,
            effect: 10
        };
        
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.innerHTML = `<span class="${isError ? 'error-msg' : 'loading'}">${message}</span>`;
        }
        
        async function loadMaterials() {
            const container = document.getElementById('banks-container');
            container.innerHTML = '';
            
            // Test Monster Banks
            await testBank('Monsters', BANKS.monster, 'monster', MATERIAL_COUNTS.monster);
            
            // Test Item Banks
            await testBank('Items', BANKS.item, 'item', MATERIAL_COUNTS.item);
            
            // Test Background Bank
            await testBank('Backgrounds', BANKS.background, 'background', MATERIAL_COUNTS.background);
            
            // Test Effect Bank
            await testBank('Effects', BANKS.effect, 'effect', MATERIAL_COUNTS.effect);
            
            updateStatus('All banks loaded');
        }
        
        async function testBank(title, bankAddresses, type, count) {
            const container = document.getElementById('banks-container');
            const section = document.createElement('div');
            section.className = 'bank-section';
            
            let html = `<h2>${title}</h2>`;
            
            // Show bank addresses
            html += '<div class="bank-info">';
            for (const [key, address] of Object.entries(bankAddresses)) {
                html += `${key}: ${address}<br>`;
            }
            html += '</div>';
            
            html += '<div class="material-grid">';
            
            for (let i = 0; i < count; i++) {
                const itemData = await loadMaterial(bankAddresses, type, i);
                html += createMaterialHTML(itemData, i);
            }
            
            html += '</div>';
            section.innerHTML = html;
            container.appendChild(section);
        }
        
        async function loadMaterial(bankAddresses, type, id) {
            try {
                let contract, svgMethod, nameMethod;
                
                // Determine which contract and method to use
                if (type === 'monster') {
                    contract = new ethers.Contract(bankAddresses.main, BANK_ABI, provider);
                    svgMethod = 'getMonsterSVG';
                    nameMethod = 'getMonsterName';
                } else if (type === 'item') {
                    contract = new ethers.Contract(bankAddresses.main, BANK_ABI, provider);
                    svgMethod = 'getItemSVG';
                    nameMethod = 'getItemName';
                } else if (type === 'background') {
                    contract = new ethers.Contract(bankAddresses.main, BANK_ABI, provider);
                    svgMethod = 'getBackgroundSVG';
                    nameMethod = 'getBackgroundName';
                } else if (type === 'effect') {
                    contract = new ethers.Contract(bankAddresses.main, BANK_ABI, provider);
                    svgMethod = 'getEffectSVG';
                    nameMethod = 'getEffectName';
                }
                
                // Get name
                const name = await contract[nameMethod](id);
                
                // Get SVG
                const svg = await contract[svgMethod](id);
                
                return {
                    name: name,
                    svg: svg,
                    error: null
                };
            } catch (error) {
                console.error(`Error loading ${type} ${id}:`, error);
                return {
                    name: `${type} ${id}`,
                    svg: null,
                    error: error.message
                };
            }
        }
        
        function createMaterialHTML(data, id) {
            const errorClass = data.error ? 'error' : '';
            let svgContent = '';
            
            if (data.svg) {
                svgContent = data.svg;
            } else if (data.error) {
                svgContent = '<div style="color: #ff4444; font-size: 12px;">Error loading SVG</div>';
            }
            
            return `
                <div class="material-item ${errorClass}">
                    <div class="svg-container">
                        ${svgContent}
                    </div>
                    <div class="material-name">${data.name}</div>
                    <div class="material-id">ID: ${id}</div>
                    ${data.error ? `<div class="error-msg">${data.error}</div>` : ''}
                </div>
            `;
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            try {
                // Load deployment configuration first
                await loadDeployment();
                
                updateStatus('Loading materials from banks...');
                await loadMaterials();
            } catch (error) {
                updateStatus('Error: ' + error.message, true);
                console.error(error);
            }
        });
    </script>
</body>
</html>