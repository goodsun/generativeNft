<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BankedNFT System with Metadata Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #0a0a0a;
        color: #ffffff;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        padding: 40px 0;
        border-bottom: 2px solid #222;
        margin-bottom: 40px;
      }

      h1 {
        font-size: 3em;
        background: linear-gradient(135deg, #ff6b6b, #dc143c);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #999;
        font-size: 1.2em;
      }

      .deployment-info {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
      }

      .deployment-info h3 {
        color: #ff6b6b;
        margin-bottom: 15px;
      }

      .deployment-info p {
        margin: 5px 0;
        font-family: monospace;
        font-size: 0.9em;
      }

      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 6px;
        font-weight: bold;
        display: none;
      }

      .status.success {
        background: #1a3a1a;
        border: 1px solid #4caf50;
        color: #4caf50;
        display: block;
      }

      .status.error {
        background: #3a1a1a;
        border: 1px solid #f44336;
        color: #f44336;
        display: block;
      }

      .status.info {
        background: #1a2a3a;
        border: 1px solid #2196f3;
        color: #2196f3;
        display: block;
      }

      .tab-container {
        margin-bottom: 30px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        justify-content: center;
        background: #1a1a1a;
        padding: 10px;
        border-radius: 8px;
      }

      .tab {
        background: #333;
        color: #fff;
        border: 1px solid #444;
        padding: 10px 30px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .tab:hover {
        background: #444;
      }

      .tab.active {
        background: #ff6b6b;
        border-color: #ff6b6b;
      }

      .content-section {
        display: none;
      }

      .content-section.active {
        display: block;
      }

      .viewer-controls {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .viewer-controls input {
        background: #0a0a0a;
        color: #fff;
        border: 1px solid #444;
        padding: 10px;
        border-radius: 6px;
        font-size: 16px;
        margin-right: 10px;
      }

      button {
        background: #ff6b6b;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover {
        background: #dc143c;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #444;
        cursor: not-allowed;
        transform: none;
      }

      .nft-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .nft-card {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s;
      }

      .nft-card:hover {
        transform: translateY(-5px);
        border-color: #ff6b6b;
      }

      .nft-image {
        width: 100%;
        height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
      }

      .nft-image svg {
        max-width: 240px;
        max-height: 240px;
      }

      .nft-details {
        padding: 20px;
      }

      .nft-details h4 {
        color: #ff6b6b;
        margin-bottom: 10px;
      }

      .trait {
        display: inline-block;
        background: #1a1a1a;
        padding: 4px 12px;
        border-radius: 16px;
        margin: 4px 4px 4px 0;
        font-size: 12px;
        border: 1px solid #333;
      }

      .trait-label {
        color: #888;
      }

      .trait-value {
        color: #fff;
        font-weight: bold;
      }

      .loading-message {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .admin-section {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .admin-section h3 {
        color: #ff6b6b;
        margin-bottom: 15px;
      }

      .function-group {
        background: #0a0a0a;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
      }

      .function-group h4 {
        color: #ffa500;
        margin-bottom: 10px;
      }

      .input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }

      .input-group label {
        min-width: 150px;
        color: #aaa;
        display: flex;
        align-items: center;
      }

      .input-group input,
      .input-group select {
        flex: 1;
        min-width: 200px;
        background: #0a0a0a;
        color: #fff;
        border: 1px solid #444;
        padding: 8px;
        border-radius: 4px;
      }

      .wallet-connect {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
      }

      .connect-button {
        background: #ffa500;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
      }

      .connect-button:hover {
        background: #ff8c00;
      }

      .tx-result {
        margin-top: 10px;
        padding: 10px;
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        display: none;
      }

      .tx-result.success {
        border-color: #4caf50;
        color: #4caf50;
      }

      .tx-result.error {
        border-color: #f44336;
        color: #f44336;
      }

      footer {
        text-align: center;
        padding: 40px 0;
        border-top: 1px solid #222;
        color: #666;
      }

      .info-panel {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .info-item {
        background: #0a0a0a;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #222;
      }

      .info-item h4 {
        color: #ff6b6b;
        margin-bottom: 8px;
      }

      .info-item p {
        color: #ccc;
        font-size: 0.9em;
      }

      .code-display {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 20px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
      }

      .display-area {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
      }

      .svg-container {
        background: #000;
        border: 2px solid #333;
        border-radius: 8px;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
      }

      .svg-container svg {
        max-width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>BankedNFT System</h1>
        <p class="subtitle">Tragedy NFT with MetadataBank Architecture</p>
      </header>

      <div class="tab-container">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('viewer')">
            NFT Viewer
          </button>
          <button class="tab" onclick="switchTab('minting')">Minting</button>
          <button class="tab" onclick="switchTab('metadata')">
            Metadata Explorer
          </button>
          <button class="tab" onclick="switchTab('admin')">Admin</button>
        </div>
      </div>

      <!-- NFT Viewer Section -->
      <div id="viewer-section" class="content-section active">
        <div class="deployment-info">
          <h3>📋 Contract Information</h3>
          <p id="network">Network: <span>Not connected</span></p>
          <p id="nft-address">BankedNFT Contract: <span>Not loaded</span></p>
          <p id="metadata-address">MetadataBank: <span>Not loaded</span></p>
          <p id="total-supply">Total Minted: <span>-</span></p>
          <p id="max-supply">Max Supply: <span>-</span></p>
          <p id="remaining-supply">Remaining: <span>-</span></p>
        </div>

        <div class="viewer-controls">
          <h3 style="color: #ff6b6b; margin-bottom: 20px">🔍 View NFTs</h3>
          <div>
            <input
              type="text"
              id="wallet-address"
              placeholder="Enter wallet address (0x...)"
              style="width: 400px"
            />
            <button onclick="loadWalletNFTs()">View Wallet</button>
            <button onclick="loadAllNFTs()">View All</button>
          </div>
          <div style="margin-top: 15px">
            <input
              type="number"
              id="token-id"
              placeholder="Token ID"
              min="1"
              style="width: 150px"
            />
            <button onclick="loadSingleNFT()">View NFT</button>
          </div>
        </div>

        <div id="status-viewer" class="status"></div>

        <div id="nft-container">
          <div class="loading-message">Select an option above to view NFTs</div>
        </div>
      </div>

      <!-- Minting Section -->
      <div id="minting-section" class="content-section">
        <div class="wallet-connect" id="wallet-section-minting">
          <h3>Connect Wallet to Mint NFTs</h3>
          <button class="connect-button" onclick="connectWallet()">
            🦊 Connect MetaMask
          </button>
          <p id="wallet-status-minting" style="margin-top: 10px; color: #888">
            Not connected
          </p>
        </div>

        <div id="minting-controls" style="display: none">
          <div class="admin-section">
            <h3>🎨 Mint Your NFT</h3>

            <div class="info-panel">
              <h4>Minting Information</h4>
              <div class="info-grid">
                <div class="info-item">
                  <h4>Mint Fee</h4>
                  <p id="mint-fee">Loading...</p>
                </div>
                <div class="info-item">
                  <h4>Your Balance</h4>
                  <p id="user-balance">Loading...</p>
                </div>
                <div class="info-item">
                  <h4>Can Mint</h4>
                  <p id="can-mint">Loading...</p>
                </div>
              </div>
            </div>

            <div class="function-group">
              <h4>Regular Mint</h4>
              <p style="color: #888; margin-bottom: 10px">
                Mint a transferable NFT with random metadata from the bank
              </p>
              <button onclick="mintNFT()">Mint NFT</button>
              <div id="mint-result" class="tx-result"></div>
            </div>

            <div class="function-group">
              <h4>Soul-Bound Mint</h4>
              <p style="color: #888; margin-bottom: 10px">
                Mint a non-transferable NFT bound to your address
              </p>
              <button onclick="mintSoulBoundNFT()">Mint Soul-Bound NFT</button>
              <div id="soulbound-result" class="tx-result"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Metadata Explorer Section -->
      <div id="metadata-section" class="content-section">
        <div class="deployment-info">
          <h3>📊 MetadataBank Information</h3>
          <p id="metadata-bank-address">
            MetadataBank: <span>Not loaded</span>
          </p>
          <p id="metadata-count">Total Metadata Entries: <span>-</span></p>
          <p id="metadata-composer">Composer Address: <span>-</span></p>
        </div>

        <div class="admin-section">
          <h3>🔍 Explore Metadata</h3>

          <div class="function-group">
            <h4>Get Metadata by Index</h4>
            <div class="input-group">
              <label>Index (0-9999):</label>
              <input
                type="number"
                id="metadata-index"
                min="0"
                max="9999"
                value="0"
              />
            </div>
            <button onclick="getMetadataByIndex()">Get Metadata</button>
            <div id="metadata-result" class="tx-result"></div>
          </div>

          <div class="function-group">
            <h4>Decode Token ID</h4>
            <div class="input-group">
              <label>Token ID:</label>
              <input type="number" id="decode-token-id" min="1" value="1" />
            </div>
            <button onclick="decodeTokenId()">Decode Parameters</button>
            <div id="decode-result" class="tx-result"></div>
          </div>

          <div class="function-group">
            <h4>Random Metadata</h4>
            <p style="color: #888; margin-bottom: 10px">
              Get a random metadata entry from the bank
            </p>
            <button onclick="getRandomMetadata()">Get Random Metadata</button>
          </div>
        </div>

        <div id="metadata-display" style="display: none">
          <div class="info-panel">
            <h3>📋 Metadata Details</h3>
            <div
              class="code-display"
              id="raw-metadata"
              style="display: block; max-height: 200px"
            ></div>
          </div>

          <div class="info-panel">
            <h3>🎨 Decoded Content</h3>
            <div class="info-grid">
              <div class="info-item">
                <h4>Name</h4>
                <p id="metadata-name">-</p>
              </div>
              <div class="info-item">
                <h4>Description</h4>
                <p id="metadata-description">-</p>
              </div>
              <div class="info-item">
                <h4>Attributes</h4>
                <div id="metadata-attributes"></div>
              </div>
            </div>
          </div>

          <div class="display-area">
            <h3 style="color: #ff6b6b; margin-bottom: 20px">🖼️ NFT Preview</h3>
            <div class="svg-container" id="metadata-svg-container">
              <p style="color: #666">Loading...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Admin Section -->
      <div id="admin-section" class="content-section">
        <div class="wallet-connect" id="wallet-section-admin">
          <h3>Connect Wallet for Admin Functions</h3>
          <button class="connect-button" onclick="connectWallet()">
            🦊 Connect MetaMask
          </button>
          <p id="wallet-status-admin" style="margin-top: 10px; color: #888">
            Not connected
          </p>
        </div>

        <div id="admin-controls" style="display: none">
          <div class="admin-section">
            <h3>👤 Owner Functions</h3>

            <div class="function-group">
              <h4>Update Configuration</h4>
              <div class="input-group">
                <label>Collection Name:</label>
                <input
                  type="text"
                  id="config-name"
                  placeholder="Tragedy Myth Banked"
                />
              </div>
              <div class="input-group">
                <label>Collection Symbol:</label>
                <input type="text" id="config-symbol" placeholder="MYTHB" />
              </div>
              <div class="input-group">
                <label>Mint Fee (ETH):</label>
                <input
                  type="number"
                  id="config-fee"
                  step="0.001"
                  min="0"
                  placeholder="0.01"
                />
              </div>
              <div class="input-group">
                <label>Royalty Rate (%):</label>
                <input
                  type="number"
                  id="config-royalty"
                  min="0"
                  max="100"
                  placeholder="5"
                />
              </div>
              <button onclick="updateConfig()">Update Configuration</button>
              <div id="config-result" class="tx-result"></div>
            </div>

            <div class="function-group">
              <h4>Set MetadataBank</h4>
              <div class="input-group">
                <label>Bank Address:</label>
                <input
                  type="text"
                  id="bank-address"
                  placeholder="0x..."
                  value="0x32fB3362690D2233e56D2d058C4943b7cAa7e80e"
                />
              </div>
              <button onclick="setMetadataBank()">Set MetadataBank</button>
              <div id="bank-result" class="tx-result"></div>
            </div>

            <div class="function-group">
              <h4>Airdrop NFT</h4>
              <div class="input-group">
                <label>Recipient Address:</label>
                <input type="text" id="airdrop-address" placeholder="0x..." />
              </div>
              <button onclick="airdropNFT()">Airdrop NFT</button>
              <div id="airdrop-result" class="tx-result"></div>
            </div>

            <div class="function-group">
              <h4>Withdraw Funds</h4>
              <p style="color: #888; margin-bottom: 10px">
                Contract Balance: <span id="contract-balance">Loading...</span>
              </p>
              <button onclick="withdrawFunds()">Withdraw All</button>
              <div id="withdraw-result" class="tx-result"></div>
            </div>
          </div>

          <div class="admin-section">
            <h3>📋 Contract Information</h3>
            <div class="function-group">
              <h4>Read Contract States</h4>
              <button onclick="refreshContractInfo()">Refresh Info</button>
              <div
                id="contract-info"
                style="
                  margin-top: 15px;
                  font-family: monospace;
                  font-size: 12px;
                  color: #aaa;
                "
              >
                Click refresh to load contract information...
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p>BankedNFT System © 2025 - Modular NFT Architecture</p>
      </footer>
    </div>

    <script>
      // Configuration - UPDATE THESE WITH YOUR DEPLOYMENT
      const RPC_URL = "https://dev2.bon-soleil.com/rpc";

      // Contract addresses - will be loaded from deployment file or hardcoded
      let BANKED_NFT_ADDRESS = null;
      let METADATA_BANK_ADDRESS = null;
      const FINAL_METADATA_BANK_ADDRESS =
        "0x32fB3362690D2233e56D2d058C4943b7cAa7e80e"; // Latest deployment

      // ABIs
      const BANKED_NFT_ABI = [
        // View functions
        "function name() view returns (string)",
        "function symbol() view returns (string)",
        "function owner() view returns (address)",
        "function maxSupply() view returns (uint256)",
        "function mintFee() view returns (uint256)",
        "function royaltyRate() view returns (uint256)",
        "function totalMinted() view returns (uint256)",
        "function metadataBank() view returns (address)",
        "function tokenURI(uint256 tokenId) view returns (string)",
        "function remainingSupply() view returns (uint256)",
        "function canMint() view returns (bool)",
        "function isSoulBound(uint256 tokenId) view returns (bool)",
        "function balanceOf(address owner) view returns (uint256)",
        "function ownerOf(uint256 tokenId) view returns (address)",
        "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
        "function totalSupply() view returns (uint256)",

        // Write functions
        "function mint() payable returns (uint256)",
        "function mintSoulBound() payable returns (uint256)",
        "function airdrop(address to) returns (uint256)",
        "function burn(uint256 tokenId)",
        "function config(string memory newName, string memory newSymbol, uint256 newMintFee, uint256 newRoyaltyRate)",
        "function setMetadataBank(address bankAddress)",
        "function withdraw()",

        // Events
        "event NFTMinted(address indexed to, uint256 indexed tokenId, address indexed minter, string metadataURI)",
        "event NFTBurned(uint256 indexed tokenId)",
        "event ConfigUpdated(string name, string symbol, uint256 mintFee, uint256 royaltyRate)",
      ];

      const METADATA_BANK_ABI = [
        "function getMetadataCount() view returns (uint256)",
        "function getMetadata(uint256 index) view returns (string)",
        "function composer() view returns (address)",
        "function decodeTokenId(uint256 tokenId) view returns (uint8 species, uint8 background, uint8 item, uint8 effect)",
        "function generateMetadata(uint256 tokenId, uint8 species, uint8 background, uint8 item, uint8 effect) view returns (string)",
      ];

      let provider;
      let bankedNft;
      let metadataBank;
      let finalMetadataBank;
      let signer;
      let currentAccount;

      async function init() {
        try {
          console.log("Initializing BankedNFT viewer...");
          showStatus("Initializing...", "info", "viewer");

          // Try to load deployment info
          try {
            // Try to load deployment.json first (standard location)
            try {
              const response = await fetch("deployment.json");
              if (response.ok) {
                const deployment = await response.json();
                if (deployment.contracts) {
                  BANKED_NFT_ADDRESS = deployment.contracts.bankedNFT || deployment.contracts.bankedNft;
                  METADATA_BANK_ADDRESS = deployment.contracts.metadataV5 || deployment.contracts.metadataBank;
                  console.log("Loaded deployment from deployment.json");
                }
              }
            } catch (e) {
              console.log("Failed to load deployment.json, trying other files...");
            }

            // If deployment.json didn't work, try other files
            if (!BANKED_NFT_ADDRESS) {
              const files = [
                "deployment-banked-bonsoleil-1754448863092.json",
                "deployment-banked-nft.json",
                "deployment-bonsoleil.json",
              ];
              let deployment = null;

              for (const file of files) {
                try {
                  const response = await fetch("../" + file);
                  if (response.ok) {
                    deployment = await response.json();
                    if (
                      deployment.contracts.bankedNft ||
                      deployment.contracts.tragedyBankedNft
                    ) {
                      BANKED_NFT_ADDRESS =
                        deployment.contracts.bankedNft ||
                        deployment.contracts.tragedyBankedNft;
                      METADATA_BANK_ADDRESS =
                        deployment.contracts.metadataBank ||
                        deployment.contracts.tragedyMetadata;
                      console.log("Loaded deployment from", file);
                      break;
                    }
                  }
                } catch (e) {
                  console.log("Failed to load", file, e);
                  continue;
                }
              }
            }

            if (!BANKED_NFT_ADDRESS) {
              // Fallback to hardcoded addresses
              BANKED_NFT_ADDRESS = "0x930Fc003DD8989E8d64b9Bba7673180C369178C5";
              METADATA_BANK_ADDRESS =
                "0x7537eBe80Ef1D4a57DbB22B6bE6B9C9a4dAff4b2";
              console.log("Using hardcoded addresses");
            }
          } catch (e) {
            console.error("Error loading deployment:", e);
            showDeploymentInstructions();
            return;
          }

          // Connect to network
          provider = new ethers.providers.JsonRpcProvider(RPC_URL);
          await provider.ready;

          // Initialize contracts
          bankedNft = new ethers.Contract(
            BANKED_NFT_ADDRESS,
            BANKED_NFT_ABI,
            provider
          );

          if (METADATA_BANK_ADDRESS) {
            metadataBank = new ethers.Contract(
              METADATA_BANK_ADDRESS,
              METADATA_BANK_ABI,
              provider
            );
            const metadataCount = await metadataBank.getMetadataCount();
            console.log(
              "MetadataBank has",
              metadataCount.toString(),
              "metadata entries"
            );
          }

          // Initialize final metadata bank for explorer
          finalMetadataBank = new ethers.Contract(
            FINAL_METADATA_BANK_ADDRESS,
            METADATA_BANK_ABI,
            provider
          );
          const finalCount = await finalMetadataBank.getMetadataCount();
          const composerAddr = await finalMetadataBank.composer();

          document.getElementById(
            "metadata-bank-address"
          ).innerHTML = `MetadataBank: <span style="color: #4caf50; font-family: monospace">${FINAL_METADATA_BANK_ADDRESS}</span>`;
          document.getElementById(
            "metadata-count"
          ).innerHTML = `Total Metadata Entries: <span style="color: #4caf50">${finalCount}</span>`;
          document.getElementById(
            "metadata-composer"
          ).innerHTML = `Composer Address: <span style="color: #4caf50; font-family: monospace">${composerAddr}</span>`;

          // Load contract info
          await loadContractInfo();

          showStatus("Connected successfully!", "success", "viewer");
        } catch (error) {
          console.error("Initialization error:", error);
          showStatus("Failed to connect: " + error.message, "error", "viewer");
        }
      }

      function showDeploymentInstructions() {
        const container = document.getElementById("nft-container");
        container.innerHTML = `
                <div style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 30px; margin: 20px 0;">
                    <h3 style="color: #ff6b6b; margin-bottom: 20px;">🚀 BankedNFT System Ready</h3>
                    <p style="margin-bottom: 15px;">The BankedNFT system is deployed and ready to use!</p>
                    <p style="color: #4caf50;">BankedNFT: 0x930Fc003DD8989E8d64b9Bba7673180C369178C5</p>
                    <p style="color: #4caf50;">MetadataBank: 0x32fB3362690D2233e56D2d058C4943b7cAa7e80e</p>
                </div>
            `;
      }

      async function loadContractInfo() {
        try {
          const [
            name,
            symbol,
            owner,
            maxSupply,
            mintFee,
            royaltyRate,
            totalMinted,
            metadataBankAddr,
          ] = await Promise.all([
            bankedNft.name(),
            bankedNft.symbol(),
            bankedNft.owner(),
            bankedNft.maxSupply(),
            bankedNft.mintFee(),
            bankedNft.royaltyRate(),
            bankedNft.totalMinted(),
            bankedNft.metadataBank(),
          ]);

          const remaining = await bankedNft.remainingSupply();

          // Update UI
          document.getElementById(
            "network"
          ).innerHTML = `Network: <span style="color: #4caf50">Bon-Soleil Testnet</span>`;
          document.getElementById(
            "nft-address"
          ).innerHTML = `BankedNFT Contract: <span style="color: #4caf50; font-family: monospace">${BANKED_NFT_ADDRESS}</span>`;
          document.getElementById(
            "metadata-address"
          ).innerHTML = `MetadataBank: <span style="color: #4caf50; font-family: monospace">${metadataBankAddr}</span>`;
          document.getElementById(
            "total-supply"
          ).innerHTML = `Total Minted: <span style="color: #4caf50">${totalMinted}</span>`;
          document.getElementById(
            "max-supply"
          ).innerHTML = `Max Supply: <span style="color: #4caf50">${maxSupply}</span>`;
          document.getElementById(
            "remaining-supply"
          ).innerHTML = `Remaining: <span style="color: #4caf50">${remaining}</span>`;

          console.log(`Loaded ${name} (${symbol}) - Owner: ${owner}`);
          console.log(`Mint fee: ${ethers.utils.formatEther(mintFee)} ETH`);
          console.log(`Royalty rate: ${royaltyRate.toNumber() / 100}%`);
        } catch (error) {
          console.error("Error loading contract info:", error);
        }
      }

      function showStatus(message, type, section = "viewer") {
        const statusId =
          section === "viewer" ? "status-viewer" : "status-" + section;
        let status = document.getElementById(statusId);
        if (!status) {
          status = document.getElementById("status-viewer");
        }

        status.textContent = message;
        status.className = "status " + type;

        if (type === "success") {
          setTimeout(() => {
            status.style.display = "none";
          }, 5000);
        }
      }

      function switchTab(tab) {
        // Update tab buttons
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");

        // Update content sections
        document
          .querySelectorAll(".content-section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(tab + "-section").classList.add("active");
      }

      async function connectWallet() {
        try {
          if (!window.ethereum) {
            alert("Please install MetaMask!");
            return;
          }

          await window.ethereum.request({ method: "eth_requestAccounts" });
          const web3Provider = new ethers.providers.Web3Provider(
            window.ethereum
          );
          signer = web3Provider.getSigner();
          currentAccount = await signer.getAddress();

          // Update contracts with signer
          bankedNft = new ethers.Contract(
            BANKED_NFT_ADDRESS,
            BANKED_NFT_ABI,
            signer
          );
          if (METADATA_BANK_ADDRESS) {
            metadataBank = new ethers.Contract(
              METADATA_BANK_ADDRESS,
              METADATA_BANK_ABI,
              signer
            );
          }

          // Update all wallet status displays
          document.getElementById(
            "wallet-status-minting"
          ).innerHTML = `Connected: ${currentAccount.slice(
            0,
            6
          )}...${currentAccount.slice(-4)}`;
          document.getElementById(
            "wallet-status-admin"
          ).innerHTML = `Connected: ${currentAccount.slice(
            0,
            6
          )}...${currentAccount.slice(-4)}`;

          // Hide connect buttons and show controls
          document.getElementById("wallet-section-minting").style.display =
            "none";
          document.getElementById("wallet-section-admin").style.display =
            "none";
          document.getElementById("minting-controls").style.display = "block";
          document.getElementById("admin-controls").style.display = "block";

          // Load minting info
          await loadMintingInfo();
        } catch (error) {
          console.error("Wallet connection error:", error);
          alert("Failed to connect wallet: " + error.message);
        }
      }

      async function loadMintingInfo() {
        try {
          const mintFee = await bankedNft.mintFee();
          const balance = await provider.getBalance(currentAccount);
          const canMint = await bankedNft.canMint();

          document.getElementById("mint-fee").textContent =
            ethers.utils.formatEther(mintFee) + " ETH";
          document.getElementById("user-balance").textContent =
            ethers.utils.formatEther(balance) + " ETH";
          document.getElementById("can-mint").textContent = canMint
            ? "Yes ✅"
            : "No ❌";

          // Update contract balance for admin
          const contractBalance = await provider.getBalance(BANKED_NFT_ADDRESS);
          document.getElementById("contract-balance").textContent =
            ethers.utils.formatEther(contractBalance) + " ETH";
        } catch (error) {
          console.error("Error loading minting info:", error);
        }
      }

      async function loadWalletNFTs() {
        const address = document.getElementById("wallet-address").value.trim();
        if (!address || !ethers.utils.isAddress(address)) {
          showStatus("Please enter a valid wallet address", "error");
          return;
        }

        showStatus("Loading wallet NFTs...", "info");
        const container = document.getElementById("nft-container");
        container.innerHTML = '<div class="loading-message">Loading...</div>';

        try {
          const balance = await bankedNft.balanceOf(address);
          if (balance.eq(0)) {
            container.innerHTML =
              '<div class="loading-message">No NFTs found in this wallet</div>';
            return;
          }

          const nfts = [];
          for (let i = 0; i < balance.toNumber(); i++) {
            const tokenId = await bankedNft.tokenOfOwnerByIndex(address, i);
            nfts.push(tokenId);
          }

          await displayNFTs(nfts);
          showStatus(`Found ${nfts.length} NFTs`, "success");
        } catch (error) {
          console.error("Error loading wallet NFTs:", error);
          showStatus("Error loading NFTs: " + error.message, "error");
          container.innerHTML =
            '<div class="loading-message">Error loading NFTs</div>';
        }
      }

      async function loadAllNFTs() {
        showStatus("Loading all NFTs...", "info");
        const container = document.getElementById("nft-container");
        container.innerHTML = '<div class="loading-message">Loading...</div>';

        try {
          const totalMinted = await bankedNft.totalMinted();

          if (totalMinted.eq(0)) {
            container.innerHTML =
              '<div class="loading-message">No NFTs minted yet</div>';
            return;
          }

          const nfts = [];
          for (let i = 1; i <= Math.min(totalMinted.toNumber(), 20); i++) {
            // Limit to 20 for performance
            nfts.push(ethers.BigNumber.from(i));
          }

          await displayNFTs(nfts);
          showStatus(
            `Showing ${nfts.length} of ${totalMinted} NFTs`,
            "success"
          );
        } catch (error) {
          console.error("Error loading all NFTs:", error);
          showStatus("Error loading NFTs: " + error.message, "error");
        }
      }

      async function loadSingleNFT() {
        const tokenId = document.getElementById("token-id").value;
        if (!tokenId || tokenId < 1) {
          showStatus("Please enter a valid token ID", "error");
          return;
        }

        showStatus(`Loading NFT #${tokenId}...`, "info");

        try {
          await displayNFTs([ethers.BigNumber.from(tokenId)]);
          showStatus(`Loaded NFT #${tokenId}`, "success");
        } catch (error) {
          console.error("Error loading NFT:", error);
          showStatus("Error: NFT not found or not minted yet", "error");
        }
      }

      async function displayNFTs(tokenIds) {
        const container = document.getElementById("nft-container");
        container.innerHTML = "";

        const grid = document.createElement("div");
        grid.className = "nft-grid";

        for (const tokenId of tokenIds) {
          try {
            // Get token URI
            const tokenURI = await bankedNft.tokenURI(tokenId);

            // Get owner and soul-bound status
            const [owner, isSoulBound] = await Promise.all([
              bankedNft.ownerOf(tokenId),
              bankedNft.isSoulBound(tokenId),
            ]);

            // Parse metadata
            let metadata;
            let svg = "";

            if (tokenURI.startsWith("data:application/json;base64,")) {
              const base64Json = tokenURI.replace(
                "data:application/json;base64,",
                ""
              );
              const jsonString = atob(base64Json);
              metadata = JSON.parse(jsonString);

              if (
                metadata.image &&
                metadata.image.startsWith("data:image/svg+xml;base64,")
              ) {
                const base64Svg = metadata.image.replace(
                  "data:image/svg+xml;base64,",
                  ""
                );
                svg = atob(base64Svg);
              }
            } else {
              // Simple metadata format
              metadata = {
                name: `NFT #${tokenId}`,
                description: tokenURI,
                attributes: [],
              };
            }

            // Create card
            const card = document.createElement("div");
            card.className = "nft-card";

            const soulBoundBadge = isSoulBound
              ? '<span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 10px;">SOUL-BOUND</span>'
              : "";

            card.innerHTML = `
                        <div class="nft-image">
                            ${
                              svg ||
                              '<div style="color: #666;">No image available</div>'
                            }
                        </div>
                        <div class="nft-details">
                            <h4>${metadata.name}${soulBoundBadge}</h4>
                            <p style="color: #888; font-size: 12px; margin-bottom: 10px;">
                                Owner: ${owner.slice(0, 6)}...${owner.slice(-4)}
                            </p>
                            <p style="color: #aaa; font-size: 13px; margin-bottom: 10px;">
                                ${metadata.description || "No description"}
                            </p>
                            ${
                              metadata.attributes.length > 0
                                ? `
                                <div>
                                    ${metadata.attributes
                                      .map(
                                        (attr) => `
                                        <span class="trait">
                                            <span class="trait-label">${attr.trait_type}:</span>
                                            <span class="trait-value">${attr.value}</span>
                                        </span>
                                    `
                                      )
                                      .join("")}
                                </div>
                            `
                                : ""
                            }
                        </div>
                    `;

            grid.appendChild(card);
          } catch (error) {
            console.error(`Error loading NFT ${tokenId}:`, error);
          }
        }

        container.appendChild(grid);
      }

      // Metadata Explorer Functions
      async function getMetadataByIndex() {
        const index = document.getElementById("metadata-index").value;
        const resultDiv = document.getElementById("metadata-result");

        try {
          resultDiv.textContent = "Loading...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const metadata = await finalMetadataBank.getMetadata(index);

          resultDiv.textContent = `Loaded metadata for index ${index}`;
          resultDiv.className = "tx-result success";

          displayMetadata(metadata);
        } catch (error) {
          console.error("Error loading metadata:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function decodeTokenId() {
        const tokenId = document.getElementById("decode-token-id").value;
        const resultDiv = document.getElementById("decode-result");

        try {
          resultDiv.textContent = "Decoding...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const params = await finalMetadataBank.decodeTokenId(tokenId);

          const species = [
            "Werewolf",
            "Goblin",
            "Frankenstein",
            "Demon",
            "Dragon",
            "Zombie",
            "Vampire",
            "Mummy",
            "Succubus",
            "Skeleton",
          ];
          const backgrounds = [
            "Bloodmoon",
            "Abyss",
            "Decay",
            "Corruption",
            "Venom",
            "Void",
            "Inferno",
            "Frost",
            "Ragnarok",
            "Shadow",
          ];
          const items = [
            "Crown",
            "Sword",
            "Shield",
            "Poison",
            "Torch",
            "Wine",
            "Scythe",
            "Staff",
            "Shoulder",
            "Amulet",
          ];
          const effects = [
            "Seizure",
            "Mindblast",
            "Confusion",
            "Meteor",
            "Bats",
            "Poisoning",
            "Lightning",
            "Blizzard",
            "Burning",
            "Brainwash",
          ];

          resultDiv.innerHTML = `
                    Token ID ${tokenId} decodes to:<br>
                    Species: ${species[params.species]} (${params.species})<br>
                    Background: ${backgrounds[params.background]} (${
            params.background
          })<br>
                    Item: ${items[params.item]} (${params.item})<br>
                    Effect: ${effects[params.effect]} (${params.effect})
                `;
          resultDiv.className = "tx-result success";

          // Get and display the metadata for these parameters
          const metadata = await finalMetadataBank.generateMetadata(
            tokenId,
            params.species,
            params.background,
            params.item,
            params.effect
          );
          displayMetadata(metadata);
        } catch (error) {
          console.error("Error decoding token:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function getRandomMetadata() {
        const randomIndex = Math.floor(Math.random() * 10000);
        document.getElementById("metadata-index").value = randomIndex;
        await getMetadataByIndex();
      }

      function displayMetadata(metadataUri) {
        const displayDiv = document.getElementById("metadata-display");
        displayDiv.style.display = "block";

        // Display raw metadata
        document.getElementById("raw-metadata").textContent = metadataUri;

        // Decode and display
        if (metadataUri.startsWith("data:application/json;base64,")) {
          try {
            const base64Json = metadataUri.replace(
              "data:application/json;base64,",
              ""
            );
            const jsonString = atob(base64Json);
            const metadata = JSON.parse(jsonString);

            document.getElementById("metadata-name").textContent =
              metadata.name || "Unknown";
            document.getElementById("metadata-description").textContent =
              metadata.description || "No description";

            // Display attributes
            const attrDiv = document.getElementById("metadata-attributes");
            attrDiv.innerHTML = metadata.attributes
              .map(
                (attr) => `
                        <span class="trait">
                            <span class="trait-label">${attr.trait_type}:</span>
                            <span class="trait-value">${attr.value}</span>
                        </span>
                    `
              )
              .join("");

            // Display SVG
            if (
              metadata.image &&
              metadata.image.startsWith("data:image/svg+xml;base64,")
            ) {
              const base64Svg = metadata.image.replace(
                "data:image/svg+xml;base64,",
                ""
              );
              const svg = atob(base64Svg);
              document.getElementById("metadata-svg-container").innerHTML = svg;
            }
          } catch (error) {
            console.error("Error parsing metadata:", error);
            document.getElementById("metadata-name").textContent =
              "Error parsing metadata";
          }
        }
      }

      // Minting functions
      async function mintNFT() {
        const resultDiv = document.getElementById("mint-result");

        try {
          resultDiv.textContent = "Preparing transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const mintFee = await bankedNft.mintFee();

          resultDiv.textContent = "Sending transaction...";
          const tx = await bankedNft.mint({ value: mintFee });
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          const receipt = await tx.wait();

          // Find the minted token ID from events
          let tokenId = "Unknown";
          if (receipt.events) {
            const event = receipt.events.find((e) => e.event === "NFTMinted");
            if (event && event.args && event.args.tokenId) {
              tokenId = event.args.tokenId.toString();
            }
          }

          resultDiv.textContent = `Success! Minted NFT #${tokenId} - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh info
          await loadContractInfo();
          await loadMintingInfo();
        } catch (error) {
          console.error("Mint error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function mintSoulBoundNFT() {
        const resultDiv = document.getElementById("soulbound-result");

        try {
          resultDiv.textContent = "Preparing transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const mintFee = await bankedNft.mintFee();

          resultDiv.textContent = "Sending transaction...";
          const tx = await bankedNft.mintSoulBound({ value: mintFee });
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          const receipt = await tx.wait();

          // Find the minted token ID from events
          let tokenId = "Unknown";
          if (receipt.events) {
            const event = receipt.events.find((e) => e.event === "NFTMinted");
            if (event && event.args && event.args.tokenId) {
              tokenId = event.args.tokenId.toString();
            }
          }

          resultDiv.textContent = `Success! Minted Soul-Bound NFT #${tokenId} - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh info
          await loadContractInfo();
          await loadMintingInfo();
        } catch (error) {
          console.error("Mint error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      // Admin functions
      async function updateConfig() {
        const name = document.getElementById("config-name").value;
        const symbol = document.getElementById("config-symbol").value;
        const fee = document.getElementById("config-fee").value;
        const royalty = document.getElementById("config-royalty").value;
        const resultDiv = document.getElementById("config-result");

        try {
          resultDiv.textContent = "Sending transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const mintFee = ethers.utils.parseEther(fee || "0");
          const royaltyRate = Math.floor((royalty || 0) * 100); // Convert percentage to basis points

          const tx = await bankedNft.config(name, symbol, mintFee, royaltyRate);
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          await tx.wait();
          resultDiv.textContent = `Success! Configuration updated - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh info
          await loadContractInfo();
        } catch (error) {
          console.error("Config error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function setMetadataBank() {
        const address = document.getElementById("bank-address").value.trim();
        const resultDiv = document.getElementById("bank-result");

        if (!ethers.utils.isAddress(address)) {
          resultDiv.textContent = "Invalid address";
          resultDiv.className = "tx-result error";
          resultDiv.style.display = "block";
          return;
        }

        try {
          resultDiv.textContent = "Sending transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const tx = await bankedNft.setMetadataBank(address);
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          await tx.wait();
          resultDiv.textContent = `Success! MetadataBank updated - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh info
          await loadContractInfo();
        } catch (error) {
          console.error("SetBank error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function airdropNFT() {
        const address = document.getElementById("airdrop-address").value.trim();
        const resultDiv = document.getElementById("airdrop-result");

        if (!ethers.utils.isAddress(address)) {
          resultDiv.textContent = "Invalid address";
          resultDiv.className = "tx-result error";
          resultDiv.style.display = "block";
          return;
        }

        try {
          resultDiv.textContent = "Sending transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const tx = await bankedNft.airdrop(address);
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          const receipt = await tx.wait();

          // Find the minted token ID from events
          let tokenId = "Unknown";
          if (receipt.events) {
            const event = receipt.events.find((e) => e.event === "NFTMinted");
            if (event && event.args && event.args.tokenId) {
              tokenId = event.args.tokenId.toString();
            }
          }

          resultDiv.textContent = `Success! Airdropped NFT #${tokenId} to ${address.slice(
            0,
            6
          )}...${address.slice(-4)} - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh info
          await loadContractInfo();
        } catch (error) {
          console.error("Airdrop error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function withdrawFunds() {
        const resultDiv = document.getElementById("withdraw-result");

        try {
          resultDiv.textContent = "Sending transaction...";
          resultDiv.className = "tx-result";
          resultDiv.style.display = "block";

          const tx = await bankedNft.withdraw();
          resultDiv.textContent = `Transaction sent: ${tx.hash}`;

          await tx.wait();
          resultDiv.textContent = `Success! Funds withdrawn - TX: ${tx.hash}`;
          resultDiv.className = "tx-result success";

          // Refresh balance
          await loadMintingInfo();
        } catch (error) {
          console.error("Withdraw error:", error);
          resultDiv.textContent = `Error: ${error.reason || error.message}`;
          resultDiv.className = "tx-result error";
        }
      }

      async function refreshContractInfo() {
        const infoDiv = document.getElementById("contract-info");

        try {
          infoDiv.innerHTML = "Loading...";

          const [
            name,
            symbol,
            owner,
            maxSupply,
            mintFee,
            royaltyRate,
            totalMinted,
            metadataBankAddr,
            canMint,
          ] = await Promise.all([
            bankedNft.name(),
            bankedNft.symbol(),
            bankedNft.owner(),
            bankedNft.maxSupply(),
            bankedNft.mintFee(),
            bankedNft.royaltyRate(),
            bankedNft.totalMinted(),
            bankedNft.metadataBank(),
            bankedNft.canMint(),
          ]);

          const contractBalance = await provider.getBalance(BANKED_NFT_ADDRESS);
          const metadataCount =
            metadataBankAddr !== ethers.constants.AddressZero && metadataBank
              ? await metadataBank.getMetadataCount()
              : 0;

          infoDiv.innerHTML = `
                    <strong>Collection Info:</strong><br>
                    Name: ${name}<br>
                    Symbol: ${symbol}<br>
                    Owner: ${owner}<br>
                    <br>
                    <strong>Supply Info:</strong><br>
                    Total Minted: ${totalMinted}<br>
                    Max Supply: ${maxSupply}<br>
                    Can Mint: ${canMint ? "Yes ✅" : "No ❌"}<br>
                    <br>
                    <strong>Configuration:</strong><br>
                    Mint Fee: ${ethers.utils.formatEther(mintFee)} ETH<br>
                    Royalty Rate: ${royaltyRate.toNumber() / 100}%<br>
                    <br>
                    <strong>Contract State:</strong><br>
                    Contract Balance: ${ethers.utils.formatEther(
                      contractBalance
                    )} ETH<br>
                    MetadataBank: ${metadataBankAddr}<br>
                    Metadata Count: ${metadataCount}<br>
                    <br>
                    <strong>Contract Addresses:</strong><br>
                    BankedNFT: ${BANKED_NFT_ADDRESS}<br>
                    MetadataBank: ${METADATA_BANK_ADDRESS || "Not set"}<br>
                    Final MetadataBank: ${FINAL_METADATA_BANK_ADDRESS}
                `;
        } catch (error) {
          console.error("Info refresh error:", error);
          infoDiv.innerHTML = `Error loading info: ${error.message}`;
        }
      }

      // Initialize on load
      window.addEventListener("load", init);
    </script>
  </body>
</html>
