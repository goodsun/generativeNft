<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Metadata & Composer</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #0a0a0a;
            color: #0f0;
            padding: 20px;
        }
        pre {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        button {
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #444; }
    </style>
</head>
<body>
    <h1>Debug Metadata & Composer</h1>
    <button onclick="checkContracts()">Check All Contracts</button>
    <button onclick="testComposer()">Test Composer</button>
    <button onclick="setupMetadata()">Setup Sample Metadata</button>
    <pre id="output">Click "Check All Contracts" to begin...</pre>

    <script>
        // V5 deployment addresses
        const CONTRACTS = {
            bankedNFT: "0xb0C8bCef9bBEd995b18E0fe6cB7029cB7c90E796",
            metadataV5: "0xbFD4e357e0552Dd26b1A4877a5DB8DDC2E4198C4",
            composerV5: "0x4036C601b705d68cA91281fdD1D665236ABbFde7",
            monsterBank1: "0xe4fc503255De4F536BBC43Fe339843F88E2e1E66",
            monsterBank2: "0xE7b23Cc85D6D9b24C4203F26A97DF7A80F9FA047",
            monsterBankV3: "0x41717f85854D631F7cb856D634fBf396beb68C93",
            itemBank1: "0x125F456DD6633E9E698FC084Ac669E08B133daaA",
            itemBank2: "0x86F003F07704F2939FB5eD40e16f13521D6c930E",
            itemBankV3: "0x2A76B76D2024bDf8018459cbf789A5B0bd277Fdc",
            backgroundBank: "0x1103d4c6108705610B08c2FFA696e3589579931E",
            effectBank: "0xA1D8e09E0F6559e992e2882555F60bE67F4e73a9"
        };
        
        const RPC_URL = "https://dev2.bon-soleil.com/rpc";
        const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
        
        const METADATA_ABI = [
            "function getMetadataCount() view returns (uint256)",
            "function getMetadata(uint256 index) view returns (string)",
            "function addMetadata(string memory uri)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function owner() view returns (address)"
        ];
        
        const COMPOSER_ABI = [
            "function monsterBank1() view returns (address)",
            "function monsterBank2() view returns (address)",
            "function monsterBankV3() view returns (address)",
            "function itemBank1() view returns (address)",
            "function itemBank2() view returns (address)",
            "function itemBankV3() view returns (address)",
            "function backgroundBank() view returns (address)",
            "function effectBank() view returns (address)",
            "function composeSVG(uint8 species, uint8 background, uint8 item, uint8 effect) view returns (string)"
        ];
        
        const NFT_ABI = [
            "function metadataBank() view returns (address)",
            "function tokenURI(uint256 tokenId) view returns (string)",
            "function totalSupply() view returns (uint256)"
        ];
        
        const BANK_ABI = [
            "function getSVG(uint256 index) view returns (string)"
        ];
        
        function log(message, type = 'success') {
            const output = document.getElementById('output');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            output.innerHTML += `<span class="${className}">${message}</span>\n`;
        }
        
        async function checkContracts() {
            const output = document.getElementById('output');
            output.innerHTML = 'Checking all contracts...\n\n';
            
            try {
                // Check NFT contract
                log('=== BankedNFT Contract ===');
                const nft = new ethers.Contract(CONTRACTS.bankedNFT, NFT_ABI, provider);
                const metadataBankAddr = await nft.metadataBank();
                log(`MetadataBank address: ${metadataBankAddr}`);
                log(`Expected: ${CONTRACTS.metadataV5}`);
                log(`Match: ${metadataBankAddr.toLowerCase() === CONTRACTS.metadataV5.toLowerCase()}\n`);
                
                // Check MetadataBank
                log('=== MetadataBank V5 ===');
                const metadataBank = new ethers.Contract(CONTRACTS.metadataV5, METADATA_ABI, provider);
                const metadataCount = await metadataBank.getMetadataCount();
                log(`Metadata count: ${metadataCount}`);
                
                if (metadataCount > 0) {
                    try {
                        const firstMetadata = await metadataBank.getMetadata(0);
                        log(`First metadata: ${firstMetadata.substring(0, 100)}...`);
                    } catch (e) {
                        log(`Error getting metadata: ${e.message}`, 'error');
                    }
                }
                
                // Check Composer banks
                log('\n=== Composer V5 Banks ===');
                const composer = new ethers.Contract(CONTRACTS.composerV5, COMPOSER_ABI, provider);
                
                const banks = [
                    { name: 'monsterBank1', expected: CONTRACTS.monsterBank1 },
                    { name: 'monsterBank2', expected: CONTRACTS.monsterBank2 },
                    { name: 'monsterBankV3', expected: CONTRACTS.monsterBankV3 },
                    { name: 'itemBank1', expected: CONTRACTS.itemBank1 },
                    { name: 'itemBank2', expected: CONTRACTS.itemBank2 },
                    { name: 'itemBankV3', expected: CONTRACTS.itemBankV3 },
                    { name: 'backgroundBank', expected: CONTRACTS.backgroundBank },
                    { name: 'effectBank', expected: CONTRACTS.effectBank }
                ];
                
                for (const bank of banks) {
                    try {
                        const addr = await composer[bank.name]();
                        const match = addr.toLowerCase() === bank.expected.toLowerCase();
                        log(`${bank.name}: ${addr} ${match ? '✓' : '✗ Expected: ' + bank.expected}`, match ? 'success' : 'error');
                    } catch (e) {
                        log(`${bank.name}: Error - ${e.message}`, 'error');
                    }
                }
                
                // Test tokenURI
                log('\n=== Testing tokenURI(1) ===');
                try {
                    const uri = await nft.tokenURI(1);
                    log(`Success! URI: ${uri.substring(0, 100)}...`);
                } catch (e) {
                    log(`Error: ${e.message}`, 'error');
                    if (e.data) {
                        log(`Error data: ${e.data}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`Fatal error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testComposer() {
            const output = document.getElementById('output');
            output.innerHTML = 'Testing Composer...\n\n';
            
            try {
                const composer = new ethers.Contract(CONTRACTS.composerV5, COMPOSER_ABI, provider);
                
                // Test with simple values (0,0,0,0)
                log('Testing composeSVG(0,0,0,0)...');
                const svg = await composer.composeSVG(0, 0, 0, 0);
                log(`SVG length: ${svg.length} characters`);
                log(`SVG preview: ${svg.substring(0, 200)}...`);
                
                // Test bank SVGs
                log('\n=== Testing Individual Banks ===');
                
                // Test monster bank
                const monsterBank = new ethers.Contract(CONTRACTS.monsterBank1, BANK_ABI, provider);
                try {
                    const monsterSvg = await monsterBank.getSVG(0);
                    log(`Monster 0 SVG length: ${monsterSvg.length}`);
                } catch (e) {
                    log(`Monster bank error: ${e.message}`, 'error');
                }
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function setupMetadata() {
            const output = document.getElementById('output');
            output.innerHTML = 'Setting up metadata...\n\n';
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    log('Please install MetaMask!', 'error');
                    return;
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                const signer = new ethers.providers.Web3Provider(window.ethereum).getSigner();
                const address = await signer.getAddress();
                log(`Connected: ${address}`);
                
                const metadataBank = new ethers.Contract(CONTRACTS.metadataV5, METADATA_ABI, signer);
                
                // Check ownership
                const owner = await metadataBank.owner();
                if (address.toLowerCase() !== owner.toLowerCase()) {
                    log(`Error: You must be the owner (${owner})`, 'error');
                    return;
                }
                
                // Create metadata that uses the composer
                const metadata = {
                    name: "Tragedy Monster #1",
                    description: "A test NFT with composer-generated image",
                    image: "", // This will be filled by the contract
                    attributes: [
                        { trait_type: "Species", value: "Werewolf" },
                        { trait_type: "Background", value: "Bloodmoon" },
                        { trait_type: "Item", value: "Crown" },
                        { trait_type: "Effect", value: "Seizure" }
                    ]
                };
                
                const uri = `data:application/json;base64,${btoa(JSON.stringify(metadata))}`;
                
                log('Sending transaction...');
                const tx = await metadataBank.addMetadata(uri);
                log(`TX: ${tx.hash}`);
                
                await tx.wait();
                log('Metadata added successfully!');
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>