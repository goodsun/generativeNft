# Tragedy NFT Arweaveハイブリッド実装 - 作業手順

## 概要
本プロジェクトは、フルオンチェーン実装の制約を克服するため、ArweaveとオンチェーンのハイブリッドアプローチでNFTシステムを構築した。

### 経緯
- 当初46個のコントラクトに分割してフルオンチェーンを実現
- SVG表現とコントラクトサイズの制約により非実用的と判断
- Arweaveを活用したハイブリッドアプローチへ転換

## 実装ワークフロー

### 1. 技術検証フェーズ
#### 1.1 色調変更フィルターの実装
- 背景テーマに応じたモンスターの色調変更を検証
- 当初のカラーマトリックスから色相回転方式へ変更（より鮮やかな色彩を実現）
- `viewer/arweave-nft-final-fixed.html`で動作確認

#### 1.2 SVG合成とBase64エンコーディング
- 複数レイヤーのSVG合成方法を確立
- 完全なSVGのBase64エンコーディング実装（部分的なエンコードの問題を修正）

### 2. スマートコントラクト開発フェーズ

#### 2.1 アセット準備フェーズ（※本実装では省略）
> **注意**: 本実装ではダミーSVGを使用していますが、実際のプロジェクトでは以下の工程が必要です：
> 
> 1. **アセットフォルダからのSVG読み込み**
>    ```
>    assets/
>    ├── monsters/     # 10種類のモンスターSVG
>    ├── items/        # 10種類のアイテムSVG
>    ├── backgrounds/  # 10種類の背景画像（Arweaveアップロード用）
>    └── effects/      # 10種類のエフェクト画像（Arweaveアップロード用）
>    ```
> 
> 2. **SVGからSolidityコードへの変換**
>    - `scripts/generate-material-contracts.js`などのスクリプトでSVGを読み込み
>    - 各SVGをSolidityの文字列として埋め込んだコントラクトを自動生成
>    - 例: `MonsterBank.sol`にwerewolf.svgの内容を埋め込む
> 
> 3. **Arweaveへのアップロード**
>    - 背景とエフェクトの画像をArweaveにアップロード
>    - 取得したTransaction IDをコントラクトに設定
> 
> このプロセスにより、実際のアートワークがブロックチェーンに永続化されます。

#### 2.2 プロジェクト初期化
```bash
cd formal_procedure_p1
npm init -y
npm install --save-dev hardhat @nomiclabs/hardhat-waffle @nomiclabs/hardhat-ethers ethers chai
npm install @openzeppelin/contracts
npx hardhat init
```

#### 2.2 コントラクト構成（7層アーキテクチャ）
1. **Base64ライブラリ** - エンコーディング処理
2. **ArweaveMonsterBank** - モンスターSVGをオンチェーン保存
3. **ArweaveItemBank** - アイテムSVGをオンチェーン保存
4. **ArweaveBackgroundBank** - 背景のArweave URL管理
5. **ArweaveEffectBank** - エフェクトのArweave URL管理
6. **ArweaveTragedyComposerV2** - SVG合成とフィルター適用
7. **TragedyMetadata** - NFTメタデータ生成
8. **TragedyMythNFT** - ERC721 NFTコントラクト

#### 2.3 コントラクト実装時の注意点
> **実装メモ**: 実際のプロジェクトでは、MonsterBankとItemBankのSVGデータは以下のような構造になります：
> ```solidity
> // 自動生成されたコード例
> function getMonsterSVG(uint8 monsterId) public pure returns (string memory) {
>     if (monsterId == 0) return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">...実際のwerewolf.svgの内容...</svg>';
>     if (monsterId == 1) return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">...実際のgoblin.svgの内容...</svg>';
>     // ... 以下同様
> }
> ```

#### 2.4 メタデータ生成の拡張（※本実装では簡略化）
> **注意**: 本実装では基本的なメタデータのみ生成していますが、実際のプロジェクトでは以下の拡張が必要です：
> 
> 1. **動的な名前生成**
>    ```solidity
>    // 例: "Venom-Infused Goblin Warrior #123"
>    string memory name = string(abi.encodePacked(
>        getBackgroundAdjective(background), " ",
>        getMonsterName(species), " ",
>        getItemTitle(item), " #",
>        toString(tokenId)
>    ));
>    ```
> 
> 2. **詳細な説明文の生成**
>    - 各組み合わせに応じたストーリー性のある説明文
>    - 背景とモンスターの関係性を反映した文章
>    - エフェクトによる特殊能力の説明
> 
> 3. **追加属性（Attributes）の実装**
>    ```json
>    {
>      "trait_type": "Rarity",
>      "value": "Legendary"  // 組み合わせによるレアリティ計算
>    },
>    {
>      "trait_type": "Power Level",
>      "value": 850  // 各要素のパワー値の合計
>    },
>    {
>      "trait_type": "Element",
>      "value": "Poison"  // 背景とエフェクトから決定
>    }
>    ```
> 
> 4. **外部メタデータの統合**
>    - OpenSeaなどのマーケットプレイス用の追加フィールド
>    - animation_url（インタラクティブビューワーのURL）
>    - external_url（専用ウェブサイトへのリンク）
>    - background_color（マーケットプレイスでの表示色）
> 
> これらの実装により、NFTの価値とユーザー体験が大幅に向上します。

#### 2.5 主要な実装ポイント
- **ハイブリッド構成**: 大容量の背景/エフェクトはArweave、小容量のモンスター/アイテムはオンチェーン
- **フィルターシステム**: 背景テーマごとの色相・彩度・明度パラメータ
- **モジュラー設計**: 各コンポーネントを独立したコントラクトとして実装

### 2.6 環境設定の注意点
> **重要**: 本番環境では以下の環境変数と設定が必要です：
> 
> 1. **.envファイルの完全な設定**
>    ```bash
>    # ネットワーク別の秘密鍵
>    MAINNET_PRIVATE_KEY=
>    TESTNET_PRIVATE_KEY=
>    
>    # API Keys
>    ETHERSCAN_API_KEY=     # コントラクト検証用
>    INFURA_PROJECT_ID=     # バックアップRPC
>    ALCHEMY_API_KEY=       # バックアップRPC
>    
>    # Arweave設定
>    ARWEAVE_WALLET_KEY=    # アップロード用ウォレット
>    ```
> 
> 2. **hardhat.config.jsの本番設定**
>    - ガス価格の自動調整
>    - 複数のRPCエンドポイント（フォールバック）
>    - Etherscan検証の設定
>    - フォークテストの設定

### 3. デプロイフェーズ

#### 3.1 コンパイル
```bash
npx hardhat compile
```

#### 3.2 段階的デプロイ
```bash
# 1. 基本コントラクトのデプロイ
npx hardhat run scripts/01-deploy-all.js --network bonsoleil

# 2. Arweave URLの設定
npx hardhat run scripts/02-update-urls.js --network bonsoleil

# 3. 動作確認
npx hardhat run scripts/03-test-composition.js --network bonsoleil

# 4. NFTコントラクトのデプロイ
npx hardhat run scripts/04-deploy-nft.js --network bonsoleil

# 5. ミントテスト
npx hardhat run scripts/05-test-minting.js --network bonsoleil
```

### 4. 検証フェーズ

#### 4.1 統合ビューワーの開発
- `viewer/index.html`にComposerとNFT Viewerを統合
- タブ切り替えで両機能にアクセス可能
- リアルタイムでのSVG生成とNFT閲覧

#### 4.2 Remix用インターフェース
- `remix/`フォルダに全コントラクトのインターフェースを配置
- コントラクトアドレス一覧（CONTRACT_ADDRESSES.md）
- Remix IDEから直接操作可能

## デプロイ結果

### Bon-Soleil Testnet (Chain ID: 21201)
```
Base64 Library:        0x552B3F94727AcdAfbD7564682F2EA8F4275D1267
ArweaveMonsterBank:    0xa07edc0A9c26B34dc77a7125ad3441d1DdE3483a
ArweaveItemBank:       0x0D72B5DCFc97b7fE8c15cE1c7c68A1c0dDC446bd
ArweaveBackgroundBank: 0xC2d0142F4748D3373BcA7BE31B1AD6bB676b66df
ArweaveEffectBank:     0xBD3E0Cc596a35e6cECD4C95e41DFf572Af2eb4db
ArweaveTragedyComposerV2: 0x0c687b850B572845EF88903d78a804B3f46E611b
TragedyMetadata:       0x18b613006C7921d6a4b9272c3ECCF5057FD395f6
TragedyMythNFT:        0xCd3272E5016Ac392c7dA55b7AeA2e0714571cA4F
```

## 技術的成果

### 1. ガス効率の改善
- フルオンチェーン版（46コントラクト）と比較して大幅なガス削減
- シングルミント: 約97,716ガス
- バッチミント（4個）: 約231,000ガス

### 2. 拡張性の確保
- Arweave URLの動的更新が可能
- フィルターパラメータの調整が可能
- 新しいアセットの追加が容易

### 3. 完全性の維持
- SVGは完全にオンチェーンで生成
- メタデータもオンチェーンで生成
- 外部依存はArweaveの永続性のみ

## フォルダ構成
```
formal_procedure_p1/
├── contracts/           # スマートコントラクト
│   ├── libraries/      # Base64ライブラリ
│   └── *.sol          # 各種コントラクト
├── scripts/            # デプロイ・テストスクリプト
├── test/              # ユニットテスト
├── viewer/            # 統合ビューワー
├── remix/             # Remix用インターフェース
└── README.md          # 詳細な技術文書
```

## 本番実装で追加が必要な要素

### 1. セキュリティと権限管理
- **Ownable拡張**: 現在は単純なowner管理だが、マルチシグやTimelockの実装推奨
- **一時停止機能**: Pausableパターンの実装（緊急時の対応）
- **アップグレード戦略**: プロキシパターンの検討（UUPS/Transparent）

### 2. ミント制御機能
- **価格設定**: ミント価格の設定と管理機能
- **供給量制限**: 最大発行数の設定
- **ホワイトリスト**: Merkle Proofによる優先ミント
- **ミント期間**: 開始・終了時刻の管理

### 3. ロイヤリティ機能
- **ERC2981準拠**: オンチェーンロイヤリティ
- **マーケットプレイス対応**: OpenSea、Blur等への最適化

### 4. ガス最適化
- **バッチ処理の改善**: multicallパターンの実装
- **ストレージ最適化**: パッキングとビットマップの活用
- **View関数の最適化**: 頻繁に呼ばれる関数のガス削減

### 5. インデックスとクエリ
- **The Graphサブグラフ**: イベントインデックス用
- **トークン検索機能**: 属性によるフィルタリング
- **統計API**: レアリティ分布、所有者分析等

### 6. 運用ツール
- **管理画面**: コントラクト管理用のWeb UI
- **モニタリング**: トランザクション監視とアラート
- **バックアップ**: メタデータとアセットの冗長化

## 今後の展開
1. メインネットへのデプロイ
2. フロントエンドアプリケーションの構築
3. マーケットプレイス統合
4. 追加アセットの制作とアップロード

## まとめ
本プロジェクトは、オンチェーンの理想と現実的な制約のバランスを取った実装例として、Arweaveとのハイブリッドアプローチの有効性を実証した。完全なオンチェーンNFTの利点を保ちながら、実用的なガスコストとスケーラビリティを実現している。