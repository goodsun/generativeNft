<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arweave + SVG NFT Composer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .svg-box {
            border: 1px solid #444;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 8px;
        }
        .svg-box h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
        }
        .svg-display {
            background: #000;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 240px;
        }
        svg {
            max-width: 100%;
            height: auto;
        }
        select {
            width: 100%;
            padding: 5px;
            margin: 10px 0;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 4px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .controls label {
            display: block;
        }
        .composed {
            grid-column: span 2;
            border: 2px solid #ff6b6b;
        }
        .info {
            margin-top: 20px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .info h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Arweave + SVG NFT Composer</h1>
    
    <h2>Select Layers:</h2>
    <div class="controls">
        <label>
            Background (Arweave):
            <select id="bg-select"></select>
        </label>
        <label>
            Monster (Local):
            <select id="monster-select"></select>
        </label>
        <label>
            Item (Local):
            <select id="item-select"></select>
        </label>
        <label>
            Effect (Arweave):
            <select id="effect-select"></select>
        </label>
    </div>
    
    <div class="container">
        <div class="svg-box">
            <h3>Original Monster</h3>
            <div id="monster-original" class="svg-display"></div>
        </div>
        
        <div class="svg-box">
            <h3>Monster with Theme Filter</h3>
            <div id="monster-filtered" class="svg-display"></div>
        </div>
        
        <div class="svg-box composed">
            <h3>Final Composed NFT</h3>
            <div id="composed-display" class="svg-display"></div>
        </div>
    </div>

    <div class="info">
        <h3>Current Selection</h3>
        <div id="selection-info">Select layers to see composition details</div>
    </div>

    <script>
        // Filter definitions for each background theme
        const filterDefinitions = {
            Bloodmoon: {
                matrix: `1.5 0.5 0.5 0 0
                        0.3 1.0 0.3 0 0
                        0.1 0.1 0.8 0 0
                        0   0   0   1 0`,
                brightness: 1.2
            },
            Abyss: {
                matrix: `0.5 0   0.5 0 0
                        0   0.7 0.3 0 0
                        0.2 0   1.0 0 0
                        0   0   0   1 0`,
                brightness: 0.7
            },
            Decay: {
                matrix: `1.0 0.2 0   0 0
                        0.2 1.0 0.2 0 0
                        0   0.2 0.8 0 0
                        0   0   0   1 0`,
                brightness: 0.9
            },
            Corruption: {
                matrix: `1.2 0.3 0.5 0 0
                        0.5 0.8 0.5 0 0
                        0.3 0.2 1.3 0 0
                        0   0   0   1 0`,
                brightness: 0.95
            },
            Venom: {
                matrix: `0.8 0.2 0   0   0.1
                        0.2 1.5 0.2 0   0
                        0   0.3 0.7 0   0
                        0   0   0   1   0`,
                brightness: 1.05
            },
            Void: {
                matrix: `0.33 0.33 0.33 0 0
                        0.33 0.33 0.33 0 0
                        0.33 0.33 0.33 0 0
                        0    0    0    1 0`,
                brightness: 0.8
            },
            Inferno: {
                matrix: `1.5 0.3 0   0 0
                        0.5 1.2 0   0 0
                        0.2 0.1 0.8 0 0
                        0   0   0   1 0`,
                brightness: 1.2
            },
            Frost: {
                matrix: `0.8 0   0.2 0 0
                        0   0.9 0.1 0 0
                        0.2 0.1 1.3 0 0
                        0   0   0   1 0`,
                brightness: 1.15
            },
            Ragnarok: {
                matrix: `1.3 0.3 0   0 0
                        0.3 0.9 0   0 0
                        0.1 0   0.8 0 0
                        0   0   0   1 0`,
                brightness: 0.85
            },
            Shadow: {
                matrix: `0.5 0   0   0 0
                        0   0.5 0   0 0
                        0   0   0.5 0 0
                        0   0   0   1 0`,
                brightness: 0.6
            }
        };

        // Data storage
        let backgroundData = {};
        let monsterData = {};
        let itemData = {};
        let effectData = {};
        
        async function loadData() {
            try {
                const [bgResponse, monsterResponse, itemResponse, effectResponse] = await Promise.all([
                    fetch('./background.json'),
                    fetch('./monster.json'),
                    fetch('./item.json'),
                    fetch('./effect.json')
                ]);
                
                backgroundData = await bgResponse.json();
                monsterData = await monsterResponse.json();
                itemData = await itemResponse.json();
                effectData = await effectResponse.json();
                
                populateSelect('bg-select', backgroundData);
                populateSelect('monster-select', monsterData);
                populateSelect('item-select', itemData);
                populateSelect('effect-select', effectData);
                
                updateDisplay();
                
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('selection-info').innerHTML = `<span style="color: #ff4444;">Error loading data: ${error.message}</span>`;
            }
        }
        
        function populateSelect(selectId, data) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">None</option>';
            
            Object.keys(data).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });
        }
        
        async function fetchAndConvertToBase64(url) {
            try {
                const response = await fetch(url);
                const text = await response.text();
                const base64 = btoa(unescape(encodeURIComponent(text)));
                return `data:image/svg+xml;base64,${base64}`;
            } catch (error) {
                console.error('Failed to fetch and convert:', url, error);
                return url;
            }
        }
        
        function createFilterDef(bgKey) {
            if (!filterDefinitions[bgKey]) return '';
            
            const filter = filterDefinitions[bgKey];
            const filterId = `filter-${bgKey}-${Date.now()}`; // Unique ID to avoid conflicts
            
            return {
                defs: `
                    <defs>
                        <filter id="${filterId}">
                            <feColorMatrix type="matrix" values="${filter.matrix}"/>
                            <feComponentTransfer>
                                <feFuncR type="linear" slope="${filter.brightness}"/>
                                <feFuncG type="linear" slope="${filter.brightness}"/>
                                <feFuncB type="linear" slope="${filter.brightness}"/>
                            </feComponentTransfer>
                        </filter>
                    </defs>
                `,
                filterId: filterId
            };
        }
        
        async function updateDisplay() {
            const bgKey = document.getElementById('bg-select').value;
            const monsterKey = document.getElementById('monster-select').value;
            const itemKey = document.getElementById('item-select').value;
            const effectKey = document.getElementById('effect-select').value;
            
            // Update selection info
            let info = [];
            if (bgKey) info.push(`Background: ${bgKey}`);
            if (monsterKey) info.push(`Monster: ${monsterKey}`);
            if (itemKey) info.push(`Item: ${itemKey}`);
            if (effectKey) info.push(`Effect: ${effectKey}`);
            document.getElementById('selection-info').innerHTML = info.length > 0 ? info.join('<br>') : 'Select layers to see composition details';
            
            // Display original monster
            if (monsterKey && monsterData[monsterKey]) {
                const base64Url = await fetchAndConvertToBase64(monsterData[monsterKey]);
                document.getElementById('monster-original').innerHTML = `
                    <svg width="240" height="240" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <image href="${base64Url}" x="0" y="0" width="24" height="24"/>
                    </svg>
                `;
                
                // Display filtered monster
                if (bgKey) {
                    const filterInfo = createFilterDef(bgKey);
                    document.getElementById('monster-filtered').innerHTML = `
                        <svg width="240" height="240" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            ${filterInfo.defs}
                            <image href="${base64Url}" x="0" y="0" width="24" height="24" filter="url(#${filterInfo.filterId})"/>
                        </svg>
                    `;
                } else {
                    document.getElementById('monster-filtered').innerHTML = '<p>Select background for filter</p>';
                }
            } else {
                document.getElementById('monster-original').innerHTML = '<p>Select a monster</p>';
                document.getElementById('monster-filtered').innerHTML = '<p>Select a monster</p>';
            }
            
            // Display composed NFT
            await displayComposed(bgKey, monsterKey, itemKey, effectKey);
        }
        
        async function displayComposed(bgKey, monsterKey, itemKey, effectKey) {
            if (!bgKey && !monsterKey && !itemKey && !effectKey) {
                document.getElementById('composed-display').innerHTML = '<p>Select layers to compose</p>';
                return;
            }
            
            let svg = '<svg width="240" height="240" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">';
            
            // Add filter definition if background is selected
            let filterInfo = null;
            if (bgKey) {
                filterInfo = createFilterDef(bgKey);
                svg += filterInfo.defs;
            }
            
            // Layer 1: Background (no filter)
            if (bgKey && backgroundData[bgKey]) {
                svg += `<image href="${backgroundData[bgKey]}" x="0" y="0" width="24" height="24"/>`;
            }
            
            // Layer 2: Monster (with filter if background selected)
            if (monsterKey && monsterData[monsterKey]) {
                const monsterBase64 = await fetchAndConvertToBase64(monsterData[monsterKey]);
                if (bgKey && filterInfo) {
                    svg += `<image href="${monsterBase64}" x="0" y="0" width="24" height="24" filter="url(#${filterInfo.filterId})"/>`;
                } else {
                    svg += `<image href="${monsterBase64}" x="0" y="0" width="24" height="24"/>`;
                }
            }
            
            // Layer 3: Item (no filter)
            if (itemKey && itemData[itemKey]) {
                const itemBase64 = await fetchAndConvertToBase64(itemData[itemKey]);
                svg += `<image href="${itemBase64}" x="0" y="0" width="24" height="24"/>`;
            }
            
            // Layer 4: Effect (no filter)
            if (effectKey && effectData[effectKey]) {
                svg += `<image href="${effectData[effectKey]}" x="0" y="0" width="24" height="24"/>`;
            }
            
            svg += '</svg>';
            document.getElementById('composed-display').innerHTML = svg;
        }
        
        // Event listeners
        document.getElementById('bg-select').addEventListener('change', updateDisplay);
        document.getElementById('monster-select').addEventListener('change', updateDisplay);
        document.getElementById('item-select').addEventListener('change', updateDisplay);
        document.getElementById('effect-select').addEventListener('change', updateDisplay);
        
        // Load data on page load
        loadData();
    </script>
</body>
</html>